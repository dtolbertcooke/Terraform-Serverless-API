# This workflow destroys the Terraform cloud infrastructure.
# Steps:
# 1. Fetch backend config from SSM Parameter Store
# 2. Initialize Terraform with remote backend
# 3. Destroy resources in the specified environment
name: Destroy Infrastructure Pipeline
description: Destroys Terraform cloud infrastructure in the specified environment.

on:
  workflow_dispatch: # Manual trigger so you only run destroy when needed
    inputs:
      region:
        description: "Region to destroy resources in (i.e. us-east-1, eu-west-2, etc.)"
        type: string
        required: true

permissions:
  id-token: write # Required for github oidc authentication with AWS
  contents: read # Allow repository contents to be checked out

jobs:
  destroy:
    name: Destroy Terraform
    runs-on: ubuntu-latest
    # Maps branch to environment (main=dev, test=test, prod=prod, global-infra=global-infra)
    environment: ${{ github.ref == 'refs/heads/main' && 'dev' ||
      github.ref == 'refs/heads/test' && 'test' ||
      github.ref == 'refs/heads/prod' && 'prod' ||
      github.ref == 'refs/heads/global-infra' && 'global-infra' }}
    env:
      ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'dev' ||
        github.ref == 'refs/heads/test' && 'test' ||
        github.ref == 'refs/heads/prod' && 'prod' ||
        github.ref == 'refs/heads/global-infra' && 'global-infra' }}

    defaults:
      run:
        working-directory: infrastructure # Keep runs scoped to environment code

    steps:
      # 1. Checkout the repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Configure AWS credentials using github environment secrets
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ github.event.inputs.region }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 3. Fetch backend config from SSM Parameter Store
      # - Retrieves global S3/DynamoDB state backend
      # - Creates backend config file for terraform init
      - name: Fetch Backend Config from SSM
        run: |
          STATE_BUCKET=$(aws ssm get-parameter --name "/tf/global-infra/backend/state-bucket" --query "Parameter.Value" --output text --region ${{ github.event.inputs.region }})
          STATE_TABLE=$(aws ssm get-parameter --name "/tf/global-infra/backend/state-table" --query "Parameter.Value" --output text --region ${{ github.event.inputs.region }})
          APP_TABLE=$(aws ssm get-parameter --name "/tf/global-infra/backend/app-table" --query "Parameter.Value" --output text --region ${{ github.event.inputs.region }} 2>/dev/null || echo "") # Handle case where app table doesn't exist (destroy global-infra before main infra)
          REGION=$(aws ssm get-parameter --name "/tf/global-infra/backend/region" --query "Parameter.Value" --output text --region ${{ github.event.inputs.region }})

          echo "STATE_BUCKET=$STATE_BUCKET" >> $GITHUB_ENV
          echo "STATE_TABLE=$STATE_TABLE" >> $GITHUB_ENV
          echo "APP_TABLE=$APP_TABLE" >> $GITHUB_ENV
          echo "REGION=$REGION" >> $GITHUB_ENV

          echo "TF_VAR_state_bucket_name=$STATE_BUCKET" >> $GITHUB_ENV

          cat > $ENVIRONMENT.hcl <<EOF
          bucket         = "$STATE_BUCKET"
          key            = "$ENVIRONMENT/terraform.tfstate"
          region         = "$REGION"
          dynamodb_table = "$STATE_TABLE"
          encrypt        = true
          EOF

      # 4. Install Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.12.2" # Pin to specific version

      # 5a. Initialize Terraform on github runner
      - name: Init Terraform (Global)
        working-directory: infrastructure/backend/global
        run: terraform init -migrate-state -force-copy -backend-config="path=./terraform.tfstate"

      # 5b. Initialize Terraform on github runner
      - name: Init Terraform (Environment)
        if: ${{ env.ENVIRONMENT != 'global-infra' }}
        run: terraform init -backend-config=${{ env.ENVIRONMENT }}.hcl

      # 6a. Disable deletion protection (if enabled)
      # - get state table from .tfvars file
      - name: Disable deletion protection (Global)
        if: ${{ env.ENVIRONMENT == 'global-infra' }}
        working-directory: infrastructure/backend/global
        run: aws dynamodb update-table --table-name $STATE_TABLE --no-deletion-protection-enabled --region ${{ github.event.inputs.region }}

      # 6b. Disable deletion protection (if enabled)
      # - get app table from SSM Parameter Store
      - name: Disable deletion protection (Environment)
        if: ${{ env.ENVIRONMENT != 'global-infra' }}
        run: aws dynamodb update-table --table-name $APP_TABLE --no-deletion-protection-enabled --region ${{ github.event.inputs.region }}

      # Empty State bucket before destroy
      - name: Empty State Bucket (Global)
        if: ${{ env.ENVIRONMENT == 'global-infra' }}
        run: |
          echo "Emptying State Bucket: $STATE_BUCKET"

          # Delete all current objects
          echo "Deleting current objects..."
          aws s3 rm s3://$STATE_BUCKET --recursive || echo "Bucket already empty"

          # Delete all object versions (if any)
          echo "Checking for object versions..."
          VERSIONS=$(aws s3api list-object-versions --bucket $STATE_BUCKET --query 'Versions' --output json)
          if [ "$VERSIONS" != "[]" ] && [ "$VERSIONS" != "null" ]; then
            echo "Deleting object versions..."
            aws s3api delete-objects \
              --bucket $STATE_BUCKET \
              --delete "$(aws s3api list-object-versions \
                --bucket $STATE_BUCKET \
                --output json \
                --query='{Objects: Versions[?Key!=null].{Key:Key,VersionId:VersionId}}')" || true
          else
            echo "No object versions found."
          fi

          # Delete all delete markers (if any)
          echo "Checking for delete markers..."
          DELETE_MARKERS=$(aws s3api list-object-versions --bucket $STATE_BUCKET --query 'DeleteMarkers' --output json)
          if [ "$DELETE_MARKERS" != "[]" ] && [ "$DELETE_MARKERS" != "null" ]; then
            echo "Deleting delete markers..."
            aws s3api delete-objects \
              --bucket $STATE_BUCKET \
              --delete "$(aws s3api list-object-versions \
                --bucket $STATE_BUCKET \
                --output json \
                --query='{Objects: DeleteMarkers[?Key!=null].{Key:Key,VersionId:VersionId}}')" || true
          else
            echo "No delete markers found."
          fi

          echo "S3 bucket $STATE_BUCKET emptied successfully."

      # 7a. Destroy resources
      - name: Destroy (Global)
        if: ${{ env.ENVIRONMENT == 'global-infra' }}
        working-directory: infrastructure/backend/global
        run: terraform destroy -var-file=${{ env.ENVIRONMENT }}.tfvars -var="aws_account_id=${{ secrets.AWS_ACCOUNT_ID }}" -auto-approve -lock=false # -lock=false to avoid locking issues on destroy

      # 9. Delete the global backend resources manually (S3 + DynamoDB)
      - name: Delete Global Backend Resources
        if: ${{ env.ENVIRONMENT == 'global-infra' }}
        run: |
          echo "Deleting backend resources for $STATE_BUCKET and $STATE_TABLE..."

          # 1. Delete S3 bucket
          echo "Deleting S3 bucket..."
          aws s3api delete-bucket --bucket $STATE_BUCKET --region $REGION || echo "Bucket already deleted or not found"

          # 2. Delete DynamoDB lock table
          echo "Deleting DynamoDB lock table..."
          aws dynamodb delete-table --table-name $STATE_TABLE --region $REGION || echo "Table already deleted or not found"

          echo "Global backend infrastructure destroyed."

      # 7b. Destroy resources
      - name: Destroy (Environment)
        if: ${{ env.ENVIRONMENT != 'global-infra' }}
        run: terraform destroy -var="environment=${{ env.ENVIRONMENT }}" -var="aws_account_id=${{ secrets.AWS_ACCOUNT_ID }}" -auto-approve -lock=false # -lock=false to avoid locking issues on destroy

      # 8. Remove backend config from SSM Parameter store
      - name: Remove Backend Config from SSM Parameter Store
        if: ${{ env.ENVIRONMENT == 'global-infra' }}
        run: |
          aws ssm delete-parameter --name "/tf/global-infra/backend/state-bucket" --region ${{ github.event.inputs.region }} || echo "Parameter already deleted"
          aws ssm delete-parameter --name "/tf/global-infra/backend/state-table" --region ${{ github.event.inputs.region }} || echo "Parameter already deleted"
          aws ssm delete-parameter --name "/tf/global-infra/backend/app-table" --region ${{ github.event.inputs.region }} || echo "Parameter already deleted"
          aws ssm delete-parameter --name "/tf/global-infra/backend/region" --region ${{ github.event.inputs.region }} || echo "Parameter already deleted"
          echo "Removed backend parameters from SSM Parameter Store."
